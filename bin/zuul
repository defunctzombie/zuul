#!/usr/bin/env node
require('superstack');

var path = require('path');
var fs = require('fs');

var colors = require('colors');
var program = require('commander');
var yaml = require('yamljs');
var xtend = require('xtend');
var osenv = require('osenv');

var Zuul = require('../lib/zuul');
var scout_browser = require('../lib/scout_browser');
var flatten_browser = require('../lib/flatten_browser');

program
.usage('[options] <files | dir>')
.option('--ui <testing ui>', 'ui for tests (mocha-bdd, mocha-tdd, qunit, tape)')
.option('--local [port]', 'port for manual testing in a local browser')
.option('--cloud_provider <testing provider>', 'run tests using a cloud provider (saucelabs, browserstack)')
.option('--tunnel', 'establish a tunnel for outside acceess. only used when --local is specified')
.option('--phantom', 'run tests in phantomjs. PhantomJS must be installed separately.')
.parse(process.argv);

var config = {
    files: program.args,
    local: program.local,
    ui: program.ui,
    tunnel: program.tunnel,
    phantom: program.phantom,
    prj_dir: process.cwd(),
    cloud_provider: process.cloud_provider
};

if (config.files.length === 0) {
    console.error('at least one `js` test file must be specified');
    return process.exit(1);
}

var cfg_file = path.join(process.cwd(), '.zuul.yml');
if (fs.existsSync(cfg_file)) {
    var zuulyml = yaml.parse(fs.readFileSync(cfg_file, 'utf-8'));
    config = xtend(config, zuulyml);
}

// optinal additional config from $HOME/.zuulrc
var home_config = path.join(osenv.home(), '.zuulrc');
if (fs.existsSync(home_config)) {
    var zuulrc = yaml.parse(fs.readFileSync(home_config, 'utf-8'));
    config = xtend(zuulrc, config);
}

var sauce_username = process.env.SAUCE_USERNAME;
var sauce_key = process.env.SAUCE_ACCESS_KEY;

config.username = sauce_username || config.sauce_username;
config.key = sauce_key || config.sauce_key;
config.cloud_provider = config.cloud_provider || 'saucelabs';

if (!config.ui) {
    console.error('Error: `ui` must be configured in .zuul.yml or specified with the --ui flag');
    return process.exit(1);
}

var pkg = {};
try {
    pkg = require(process.cwd() + '/package.json');
} catch (err) {}

config.name = config.name || pkg.name || 'there is only zuul';

if (config.cloud_provider === 'browserstack') {
    config.browserstack.username = config.browserstack.username ||
        process.env.BROWSERSTACK_USERNAME;
    config.browserstack.key = config.browserstack.key ||
        process.env.BROWSERSTACK_KEY;

    config.concurrency = config.browserstack.concurrency ||
        config.concurrency;
}

if (config.builder) {
    // relative path will needs to be under project dir
    if (config.builder[0] === '.') {
        config.builder = path.resolve(config.prj_dir, config.builder);
    }

    config.builder = require.resolve(config.builder);
}

var zuul = Zuul(config);

if (config.local) {
    return zuul.run(function(passed) {
    });
}
else if (config.phantom) {
    return zuul.run(function(passed) {
        process.exit(passed ? 0 : 1);
    });
}
else if (config.cloud_provider === 'browserstack') {
    if (!config.browserstack.username || !config.browserstack.key) {
        console.error('Error:');
        console.error('Zuul tried to run tests in browserstack, however no saucelabs credentials were provided.');
        console.error('See the zuul wiki (https://github.com/defunctzombie/zuul/wiki/Cloud-testing) for info on how to setup cloud testing.');
        process.exit(1);
        return;
    }

    zuul.registerCloudReporter();

    return zuul.run(function(passed, results) {
        if (passed) {
            console.log('all browsers passed'.green);
        }
        else {
            console.log('%d browser(s) failed'.red, results.failed_count);
        }
        process.exit(passed ? 0 : 1);
    });
}

if (!config.username || !config.key) {
    console.error('Error:');
    console.error('Zuul tried to run tests in saucelabs, however no saucelabs credentials were provided.');
    console.error('See the zuul wiki (https://github.com/defunctzombie/zuul/wiki/Cloud-testing) for info on how to setup cloud testing.');
    process.exit(1);
    return;
}

scout_browser(function(err, all_browsers) {
    if (err) {
        console.error('Unable to get available browsers for saucelabs'.red);
        console.error(err.stack);
        return process.exit(1);
    }

    // common mappings for some of us senile folks
    all_browsers.iexplore = all_browsers['internet explorer'];
    all_browsers.ie = all_browsers['internet explorer'];
    all_browsers.googlechrome = all_browsers.chrome;

    if (!config.browsers) {
        console.error('no cloud browsers specified in .zuul.yml');
        return process.exit(1);
    }

    // flatten into list of testable browsers
    var to_test = flatten_browser(config.browsers, all_browsers);

    // pretty prints which browsers we will test on what platforms
    {
        var by_os = {};
        to_test.forEach(function(browser) {
            var key = browser.name + ' @ ' + browser.platform;
            (by_os[key] = by_os[key] || []).push(browser.version);
        });

        for (var item in by_os) {
            console.log('- testing: %s: %s'.grey, item, by_os[item].join(' '));
        }
    }

    to_test.forEach(function(info) {
        zuul.browser(info);
    });

    zuul.registerCloudReporter();

    zuul.run(function(passed, results) {
        if (passed) {
            console.log('all browsers passed'.green);
        }
        else {
            console.log('%d browser(s) failed'.red, results.failed_count);
        }
        process.exit(passed ? 0 : 1);
    });
});

// vim: ft=javascript
